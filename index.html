<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bass Fretboard Trainer</title>
    <link rel="manifest" href="manifest.json">
    <style>
        /* --- STILI GLOBALI --- */
        :root {
            --bg-color: #121212;
            --text-color: #FFFFFF;
            --primary-color: #FFFF00; /* Giallo */
            --secondary-color: #333333;
            --border-color: #555555;
            --correct-color: #28a745; /* Verde */
            --incorrect-color: #dc3545; /* Rosso */
            --missed-color: #007bff; /* Blu */
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 900px;
            text-align: center;
            padding-top: 40px;
        }
        
        /* --- SCHERMATE --- */
        .screen { display: none; }
        .screen.active { display: block; }

        h1, h2 { color: var(--primary-color); }

        /* --- BOTTONI --- */
        .btn {
            background-color: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            padding: 12px 24px;
            font-size: 1.1em;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.2s, color 0.2s;
            margin: 10px 5px;
            text-transform: uppercase;
            font-weight: bold;
        }
        .btn:hover { background-color: var(--primary-color); color: var(--bg-color); }
        .btn-small { padding: 8px 16px; font-size: 0.9em; }
        
        /* --- TASTIERA --- */
        #fretboard-container { overflow-x: auto; }
        
        .fretboard {
            border-collapse: collapse;
            margin: 30px auto;
            border: 2px solid var(--border-color);
        }

        .fretboard th, .fretboard td {
            min-width: 50px;
            height: 40px;
            border: 1px solid var(--border-color);
            vertical-align: middle;
            font-size: 1.2em;
            font-weight: bold;
            box-sizing: border-box;
            position: relative;
        }

        .fretboard th { color: var(--primary-color); }
        
        .fretboard .dot::after {
            content: '●';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.2em;
            color: var(--border-color);
        }
        .fretboard .double-dot::after {
            content: '● ●';
            letter-spacing: -5px;
        }

        .string-name { background-color: var(--secondary-color); color: var(--primary-color); }
        .fret-cell.clickable { cursor: pointer; }
        
        /* Stati delle celle */
        .highlight { background-color: var(--primary-color); color: var(--bg-color); border-radius: 4px; }
        .selected { background-color: rgba(255, 255, 0, 0.5); border: 2px solid var(--primary-color); }
        .fret-cell.feedback-correct { background-color: var(--correct-color); color: white; }
        .fret-cell.feedback-incorrect { background-color: var(--incorrect-color); color: white; }
        .fret-cell.feedback-missed { background-color: var(--missed-color); color: white; }

        /* --- CONTROLLI --- */
        #note-choices, #find-note-controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px; }
        .note-button { background-color: var(--secondary-color); color: var(--text-color); border: 2px solid var(--border-color); padding: 10px 15px; font-size: 1em; cursor: pointer; border-radius: 5px; }
        .note-button:hover { background-color: var(--border-color); }
        .note-button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- IMPOSTAZIONI --- */
        .settings-group, .setup-group { margin: 25px 0; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; }
        .settings-group label, .setup-group label { margin: 0 10px; font-size: 1.1em; }
        .checkbox-group { display: flex; justify-content: center; gap: 20px; margin-top: 10px; flex-wrap: wrap; }

        /* --- FEEDBACK --- */
        .feedback-message { height: 30px; font-size: 1.5em; font-weight: bold; margin: 20px 0; }
        .feedback-correct { color: var(--primary-color); }
        .feedback-incorrect { color: var(--incorrect-color); }
    </style>
</head>
<body>

<div class="container">

    <!-- Schermate -->
    <div id="menu-screen" class="screen active">
        <h1>Bass Fretboard Trainer</h1>
        <p>Scegli una modalità per iniziare ad allenarti.</p>
        <div>
            <button class="btn" onclick="navigateTo('guess-mode-setup-screen')">Indovina la Nota</button>
            <button class="btn" onclick="navigateTo('find-mode-game-screen')">Trova la Nota</button>
            <button class="btn btn-small" onclick="navigateTo('settings-screen')">Impostazioni</button>
        </div>
    </div>

    <div id="guess-mode-setup-screen" class="screen">
        <h2>Imposta Esercizio</h2>
        <div class="setup-group">
            <h3>Scegli le corde</h3>
            <div class="checkbox-group" id="string-selector"></div>
        </div>
        <div class="setup-group">
            <h3>Scegli il range dei tasti</h3>
            Da <input type="number" id="fret-start" value="1" min="1" max="12" style="width: 50px;">
            A <input type="number" id="fret-end" value="12" min="1" max="12" style="width: 50px;">
        </div>
        <button class="btn" onclick="startGuessMode()">Inizia!</button>
        <button class="btn btn-small" onclick="navigateTo('menu-screen')">Torna al Menu</button>
    </div>

    <div id="guess-mode-game-screen" class="screen">
        <h2 id="guess-title">Indovina la Nota</h2>
        <div id="fretboard-container-guess"></div>
        <div id="feedback-guess" class="feedback-message"></div>
        <div id="note-choices"></div>
        <button class="btn btn-small" onclick="navigateTo('menu-screen')">Torna al Menu</button>
    </div>
    
    <div id="find-mode-game-screen" class="screen">
        <h2 id="find-title">Trova tutte le note...</h2>
        <div id="fretboard-container-find"></div>
        <div id="find-note-controls">
            <button class="btn" id="check-find-answer-btn">Controlla</button>
            <button class="btn" id="next-find-question-btn" style="display:none;">Prossima Nota</button>
        </div>
        <button class="btn btn-small" onclick="navigateTo('menu-screen')">Torna al Menu</button>
    </div>

    <div id="settings-screen" class="screen">
        <h2>Impostazioni</h2>
        <div class="settings-group">
            <h3>Sistema di Notazione</h3>
            <label><input type="radio" name="notation" value="international" checked> Internazionale (C, D, E...)</label>
            <label><input type="radio" name="notation" value="italian"> Italiano (Do, Re, Mi...)</label>
        </div>
        <button class="btn" onclick="saveSettings()">Salva e Torna al Menu</button>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- DATI E STATO DELL'APP ---
    const NOTES_DATA = {
        international: ['G', 'G#', 'A', 'A#', 'B', 'C', 'C#', 'D', 'D#', 'E', 'F', 'F#'],
        italian: ['Sol', 'Sol#', 'La', 'La#', 'Si', 'Do', 'Do#', 'Re', 'Re#', 'Mi', 'Fa', 'Fa#']
    };
    const STRINGS = { 'G': 0, 'D': 7, 'A': 2, 'E': 9 };
    const STRING_ORDER = ['G', 'D', 'A', 'E'];
    const STRING_TRANSLATIONS = {
        international: { E: 'E', A: 'A', D: 'D', G: 'G' },
        italian:       { E: 'Mi', A: 'La', D: 'Re', G: 'Sol' }
    };
    const FRET_COUNT = 12;
    const DOTS = [3, 5, 7, 9, 12];

    let appState = {
        settings: { notation: 'international' },
        guessMode: { config: { strings: [], fretRange: { start: 1, end: 12 } }, currentQuestion: {}, timeoutId: null },
        findMode: { targetNote: null, userSelection: [] }
    };
    
    const screens = document.querySelectorAll('.screen');
    const fretboardContainerGuess = document.getElementById('fretboard-container-guess');
    const fretboardContainerFind = document.getElementById('fretboard-container-find');
    const noteChoicesContainer = document.getElementById('note-choices');
    const feedbackGuessEl = document.getElementById('feedback-guess');
    const findTitleEl = document.getElementById('find-title');
    const checkFindAnswerBtn = document.getElementById('check-find-answer-btn');
    const nextFindQuestionBtn = document.getElementById('next-find-question-btn');

    // --- NUOVA CONFIGURAZIONE AUDIO ---
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const noteFrequencies = {
        'C': 65.41, 'C#': 69.30, 'D': 73.42, 'D#': 77.78, 'E': 82.41, 'F': 87.31,
        'F#': 92.50, 'G': 98.00, 'G#': 103.83, 'A': 110.00, 'A#': 116.54, 'B': 123.47,
        'Do': 65.41, 'Do#': 69.30, 'Re': 73.42, 'Re#': 77.78, 'Mi': 82.41, 'Fa': 87.31,
        'Fa#': 92.50, 'Sol': 98.00, 'Sol#': 103.83, 'La': 110.00, 'La#': 116.54, 'Si': 123.47
    };

    // SOSTITUISCI CON QUESTO NUOVO BLOCCO
function playSound(noteName, duration = 0.6) {
    if (!audioContext || !noteFrequencies[noteName]) return;
    if (audioContext.state === 'suspended') {
        audioContext.resume();
    }

    // 1. Oscillatore: la fonte del suono. Usiamo ancora 'sawtooth' per la sua ricchezza.
    const oscillator = audioContext.createOscillator();
    oscillator.type = 'square';
    oscillator.frequency.setValueAtTime(noteFrequencies[noteName], audioContext.currentTime);

    // 2. Filtro: il "modellatore" del tono. Togliamo le frequenze aspre.
    const filter = audioContext.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.setValueAtTime(600, audioContext.currentTime); // Valore chiave! Più basso = più cupo.

    // 3. GainNode: controlla il volume e l'inviluppo.
    const gainNode = audioContext.createGain();

    // 4. Colleghiamo tutto in catena: Suono -> Filtro -> Volume -> Altoparlanti
    oscillator.connect(filter);
    filter.connect(gainNode);
    gainNode.connect(audioContext.destination);

    // 5. Inviluppo migliorato: attacco deciso e decadimento più naturale.
    const now = audioContext.currentTime;
    gainNode.gain.setValueAtTime(0, now);
    gainNode.gain.linearRampToValueAtTime(0.7, now + 0.01); // Attacco molto rapido e forte ("pluck")
    gainNode.gain.exponentialRampToValueAtTime(0.0001, now + duration); // Decadimento esponenziale, più naturale.

    // Avvia e ferma il suono
    oscillator.start(now);
    oscillator.stop(now + duration);
}

    // --- FUNZIONI DI NAVIGAZIONE E INIZIALIZZAZIONE ---
    window.navigateTo = (screenId) => {
        screens.forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        if (screenId === 'find-mode-game-screen') startFindMode();
        if (screenId === 'guess-mode-setup-screen') setupStringSelector();
    };
    
    function init() {
        loadSettings();
        checkFindAnswerBtn.addEventListener('click', checkFindAnswer);
        nextFindQuestionBtn.addEventListener('click', askFindQuestion);
        // Attiva l'audio al primo tocco per compatibilità con i browser mobile
        document.body.addEventListener('click', () => {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }, { once: true });
        navigateTo('menu-screen');
    }

    // --- FUNZIONI COMUNI ---
    function createFretboard(container, isClickable = false) {
        let table = '<table class="fretboard"><thead><tr><th></th>';
        for(let i = 1; i <= FRET_COUNT; i++) {
            let dotClass = DOTS.includes(i) ? 'dot' + (i === 12 ? ' double-dot' : '') : '';
            table += `<th class="${dotClass}">${i}</th>`;
        }
        table += '</tr></thead><tbody>';

        const translations = STRING_TRANSLATIONS[appState.settings.notation];
        STRING_ORDER.forEach(stringName => {
            const displayName = translations[stringName];
            table += `<tr><td class="string-name">${displayName}</td>`;
            for (let fret = 1; fret <= FRET_COUNT; fret++) {
                table += `<td class="fret-cell ${isClickable ? 'clickable' : ''}" data-string="${stringName}" data-fret="${fret}"></td>`;
            }
            table += '</tr>';
        });

        table += '</tbody></table>';
        container.innerHTML = table;
        
        if (isClickable) {
            container.querySelectorAll('.fret-cell').forEach(cell => cell.addEventListener('click', handleFretClick));
        }
    }
    
    function getNoteForFret(stringName, fret) {
        const openStringIndex = STRINGS[stringName];
        const noteIndex = (openStringIndex + parseInt(fret)) % 12;
        return NOTES_DATA[appState.settings.notation][noteIndex];
    }

    // --- MODALITÀ: INDOVINA LA NOTA ---
    function setupStringSelector() {
        const container = document.getElementById('string-selector');
        const translations = STRING_TRANSLATIONS[appState.settings.notation];
        container.innerHTML = '';
        STRING_ORDER.forEach(stringName => {
            const displayName = translations[stringName];
            container.innerHTML += `<label><input type="checkbox" name="string" value="${stringName}" checked> ${displayName}</label>`;
        });
    }

    window.startGuessMode = () => {
        const selectedStrings = Array.from(document.querySelectorAll('#string-selector input:checked')).map(cb => cb.value);
        const fretStart = parseInt(document.getElementById('fret-start').value);
        const fretEnd = parseInt(document.getElementById('fret-end').value);

        if (selectedStrings.length === 0) { alert('Seleziona almeno una corda!'); return; }
        if (fretStart > fretEnd) { alert('Il tasto di inizio non può essere maggiore di quello di fine.'); return; }
        
        appState.guessMode.config = { strings: selectedStrings, fretRange: { start: fretStart, end: fretEnd } };
        
        navigateTo('guess-mode-game-screen');
        createFretboard(fretboardContainerGuess);
        createNoteButtons();
        askGuessQuestion();
    };
    
    function createNoteButtons() {
        noteChoicesContainer.innerHTML = '';
        NOTES_DATA[appState.settings.notation].forEach(note => {
            const button = document.createElement('button');
            button.className = 'note-button';
            button.textContent = note;
            button.onclick = () => checkGuessAnswer(note);
            noteChoicesContainer.appendChild(button);
        });
    }

    function askGuessQuestion() {
        clearTimeout(appState.guessMode.timeoutId);
        
        const prevCell = fretboardContainerGuess.querySelector('.fret-cell.highlight, .fret-cell.feedback-correct, .fret-cell.feedback-incorrect');
        if (prevCell) {
            prevCell.className = 'fret-cell';
            prevCell.textContent = '';
        }
        feedbackGuessEl.textContent = '';
        feedbackGuessEl.className = 'feedback-message';
        document.querySelectorAll('.note-button').forEach(b => b.disabled = false);

        const { strings, fretRange } = appState.guessMode.config;
        const randomString = strings[Math.floor(Math.random() * strings.length)];
        const randomFret = Math.floor(Math.random() * (fretRange.end - fretRange.start + 1)) + fretRange.start;
        const correctNote = getNoteForFret(randomString, randomFret);
        
        const cell = fretboardContainerGuess.querySelector(`[data-string="${randomString}"][data-fret="${randomFret}"]`);
        cell.classList.add('highlight');
        appState.guessMode.currentQuestion = { note: correctNote, cellElement: cell };
    }
    
    function checkGuessAnswer(selectedNote) {
        clearTimeout(appState.guessMode.timeoutId);
        const { note, cellElement } = appState.guessMode.currentQuestion;
        
        document.querySelectorAll('.note-button').forEach(b => b.disabled = true);
        cellElement.classList.remove('highlight');
        cellElement.textContent = note;
        playSound(note);

        if (selectedNote === note) {
            feedbackGuessEl.textContent = 'Corretto!';
            feedbackGuessEl.className = 'feedback-message feedback-correct';
            cellElement.classList.add('feedback-correct');
        } else {
            feedbackGuessEl.textContent = `Sbagliato! Era ${note}`;
            feedbackGuessEl.className = 'feedback-message feedback-incorrect';
            cellElement.classList.add('feedback-incorrect');
        }
        appState.guessMode.timeoutId = setTimeout(askGuessQuestion, 2000);
    }

    // --- MODALITÀ: TROVA LA NOTA ---
    function startFindMode() {
        createFretboard(fretboardContainerFind, true);
        askFindQuestion();
    }

    function askFindQuestion() {
        fretboardContainerFind.querySelectorAll('.fret-cell').forEach(cell => {
            cell.className = 'fret-cell clickable';
            cell.textContent = '';
        });
        
        appState.findMode.userSelection = [];
        const notes = NOTES_DATA[appState.settings.notation];
        appState.findMode.targetNote = notes[Math.floor(Math.random() * notes.length)];
        playSound(appState.findMode.targetNote);
        
        findTitleEl.textContent = `Trova tutte le note "${appState.findMode.targetNote}"`;
        checkFindAnswerBtn.style.display = 'inline-block';
        nextFindQuestionBtn.style.display = 'none';
    }
    
    function handleFretClick(event) {
        const cell = event.target;
        if (!cell.classList.contains('clickable')) return;
        const string = cell.dataset.string;
        const fret = parseInt(cell.dataset.fret);
        
        const selectionIndex = appState.findMode.userSelection.findIndex(s => s.string === string && s.fret === fret);
        
        if (selectionIndex > -1) {
            appState.findMode.userSelection.splice(selectionIndex, 1);
            cell.classList.remove('selected');
        } else {
            appState.findMode.userSelection.push({ string, fret });
            cell.classList.add('selected');
        }
    }
    
    function checkFindAnswer() {
        const { targetNote, userSelection } = appState.findMode;
        fretboardContainerFind.querySelectorAll('.fret-cell').forEach(cell => {
            const string = cell.dataset.string;
            const fret = parseInt(cell.dataset.fret);
            const correctNote = getNoteForFret(string, fret);
            const isCorrect = correctNote === targetNote;
            const isSelected = userSelection.some(s => s.string === string && s.fret === fret);
            
            cell.classList.remove('selected', 'clickable');
            
            if (isCorrect && isSelected) cell.classList.add('feedback-correct');
            else if (!isCorrect && isSelected) cell.classList.add('feedback-incorrect');
            else if (isCorrect && !isSelected) cell.classList.add('feedback-missed');
            if(isCorrect) cell.textContent = correctNote;
        });

        checkFindAnswerBtn.style.display = 'none';
        nextFindQuestionBtn.style.display = 'inline-block';
    }

    // --- IMPOSTAZIONI ---
    function loadSettings() {
        const savedSettings = localStorage.getItem('bassTrainerSettings');
        if (savedSettings) appState.settings = JSON.parse(savedSettings);
        document.querySelector(`input[name="notation"][value="${appState.settings.notation}"]`).checked = true;
    }

    window.saveSettings = () => {
        appState.settings.notation = document.querySelector('input[name="notation"]:checked').value;
        localStorage.setItem('bassTrainerSettings', JSON.stringify(appState.settings));
        alert('Impostazioni salvate!');
        navigateTo('menu-screen');
    };

    init();
});
</script>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => console.log('Service Worker registrato:', registration))
                .catch(err => console.log('Registrazione Service Worker fallita:', err));
        });
    }
</script>

</body>
</html>